trigger:
  - develop

# variables:
#   HEALTH_PROBE: false

resources:
  - repo: self

pool: build-scaleset

stages:
  - stage: Build
    displayName: Build
    jobs:
      - job: Build
        displayName: Build
        pool: build-scaleset
        steps:
          - task: Docker@2
            inputs:
              containerRegistry: "dev-acr"
              repository: "InternationalAudit"
              command: "build"
              Dockerfile: "**/Dockerfile"
              buildContext: "$(Build.SourcesDirectory)"
              tags: "$(Build.BuildId)"
              arguments: "--pull --no-cache"

            # STEP 2: Push image
          - task: Docker@2
            displayName: Push image
            inputs:
              containerRegistry: "dev-acr"
              repository: "InternationalAudit"
              command: "push"
              tags: "$(Build.BuildId)"
  - stage: Deployment
    displayName: Deployment
    jobs:
      - job: Deployment
        displayName: Deployment
        pool: build-scaleset
        steps:
          - script: |
              helm uninstall faa-international-streamlit -n insightrx-dev || true
            displayName: "Uninstall old Helm release"
          # - checkout: infra
          #   fetchDepth: 1
          #   persistCredentials: true

          - task: HelmInstaller@0
            inputs:
              helmVersionToInstall: "3.13.3"
          - task: HelmDeploy@0
            inputs:
              arguments: "--timeout 10m"
              connectionType: "Kubernetes Service Connection"
              kubernetesServiceConnection: 'vidal-dev-aks'
              namespace: 'insightrx-dev'
              command: "upgrade"
              chartType: "FilePath"
              chartPath: "./deployment/helm-chart"
              releaseName: "international-audit-streamlit"
              overrideValues: "image.tag=$(Build.BuildId),releaseName=international-audit-streamlit"
              valueFile: "./deployment/helm-chart/values-dev.yaml"